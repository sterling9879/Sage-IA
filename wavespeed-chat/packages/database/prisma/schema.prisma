generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== USUÁRIOS ==============

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?   // Hash bcrypt
  name          String?
  image         String?
  emailVerified DateTime?

  // Plano e limites
  plan          Plan      @default(FREE)
  messagesUsed  Int       @default(0)
  messagesLimit Int       @default(50)  // Por dia

  // Status
  isActive      Boolean   @default(true)
  isBanned      Boolean   @default(false)
  banReason     String?

  // Preferências
  defaultModel  String    @default("google/gemini-2.5-flash")
  theme         Theme     @default(SYSTEM)

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  lastActiveAt  DateTime?

  // Relações
  conversations Conversation[]
  messages      Message[]
  sessions      Session[]
  accounts      Account[]
  usageLogs     UsageLog[]

  @@index([email])
  @@index([createdAt])
}

enum Plan {
  FREE
  PRO
  UNLIMITED
}

enum Theme {
  LIGHT
  DARK
  SYSTEM
}

// ============== AUTH (NextAuth) ==============

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Info adicional
  userAgent    String?
  ipAddress    String?

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============== CONVERSAS ==============

model Conversation {
  id        String   @id @default(cuid())
  title     String?
  userId    String

  // Modelo padrão da conversa
  model     String   @default("google/gemini-2.5-flash")

  // Metadata
  isArchived Boolean @default(false)
  isPinned   Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([userId])
  @@index([createdAt])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  userId         String

  role           Role
  content        String   @db.Text

  // Modelo usado (para respostas do assistant)
  model          String?

  // Tokens (para tracking de uso)
  promptTokens   Int?
  completionTokens Int?

  // Status
  isEdited       Boolean  @default(false)
  editedAt       DateTime?

  // Timestamps
  createdAt      DateTime @default(now())

  // Relações
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
}

enum Role {
  USER
  ASSISTANT
  SYSTEM
}

// ============== ADMIN ==============

model AdminUser {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Hash bcrypt
  name      String
  role      AdminRole @default(ADMIN)

  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?

  @@index([email])
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  VIEWER
}

// ============== CONFIGURAÇÕES ==============

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  type      SettingType @default(STRING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

// Tabela específica para API Keys (criptografadas)
model ApiKey {
  id          String   @id @default(cuid())
  provider    String   // wavespeed, openai, etc
  name        String   // Nome amigável
  key         String   // Criptografado
  isActive    Boolean  @default(true)

  // Uso
  usageCount  Int      @default(0)
  lastUsedAt  DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([provider, name])
}

// Configuração de modelos disponíveis
model ModelConfig {
  id          String   @id @default(cuid())
  modelId     String   @unique  // "anthropic/claude-3.7-sonnet"
  displayName String             // "Claude 3.7 Sonnet"
  provider    String             // "anthropic"

  isEnabled   Boolean  @default(true)
  isFree      Boolean  @default(false)

  // Limites
  maxTokens   Int      @default(4096)

  // Ordem de exibição
  sortOrder   Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([provider])
  @@index([isEnabled])
}

// ============== LOGS E ANALYTICS ==============

model UsageLog {
  id             String   @id @default(cuid())
  userId         String
  conversationId String?

  // Detalhes da requisição
  model          String
  promptTokens   Int
  completionTokens Int
  totalTokens    Int

  // Custo estimado (em centavos)
  estimatedCost  Int?

  // Tempo de resposta (ms)
  responseTime   Int?

  // Status
  success        Boolean  @default(true)
  errorMessage   String?

  createdAt      DateTime @default(now())

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([model])
}

model SystemLog {
  id        String   @id @default(cuid())
  level     LogLevel
  message   String   @db.Text
  context   Json?

  createdAt DateTime @default(now())

  @@index([level])
  @@index([createdAt])
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  FATAL
}
